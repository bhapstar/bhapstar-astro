<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gallery — bhapstar</title>
  <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "b3353c7dd8764a64baee57fd09c3dbb9"}'></script><!-- End Cloudflare Web Analytics -->
  <link rel="stylesheet" href="styles.css" />


  <!-- Page-specific CSS for the gallery + lightbox (kept inline so this file is self-contained) -->
  <style>
    /* =========================================================
       GALLERY PAGE: inline styles
       - Lightbox layout + controls
       - Multi-image badge
       - Mobile-only tweaks (hide long descriptions in tiles)
       Note: site-wide styling lives in styles.css
    ========================================================= */
    /* Lightbox */
    .lightbox{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.92);
      z-index: 9999;
      padding: 18px;
    }
    .lightbox.open{ display: flex; }

    .lightbox-inner{
      position: relative;
      width: min(1200px, 100%);
      height: min(82vh, 900px);
      border-radius: 16px;
      overflow: hidden;
      background: rgba(0,0,0,.35);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }

    .lightbox-img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none; /* stops direct drag from the image */
    }
    /* Watermark overlay (bottom third) */
    .lightbox-watermark.lightbox-watermark{
      position: absolute;
      inset: 0;                /* fills the entire image */
      display: flex;
      align-items: center;     /* vertical centre */
      justify-content: center; /* horizontal centre */
      pointer-events: none;
    }
    .lightbox-watermark span{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      text-transform: lowercase;
      letter-spacing: .12em;
      font-weight: 700;
      font-size: clamp(40px, 10vw, 120px);
      opacity: .05;          /* <-- adjust watermark strength here */
      color: #fff;
      transform: rotate(-12deg);
      text-shadow: 0 8px 22px rgba(0,0,0,.35);
      mix-blend-mode: screen; /* keeps it light */
      user-select: none;
      white-space: nowrap;
    }

    /* Close button */
    .lightbox-close{
      position: absolute;
      top: 12px;
      right: 12px;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: blur(6px);
    }
    .lightbox-close:hover{ background: rgba(0,0,0,.55); }

    /* Small caption */
    .lightbox-meta{
      position: absolute;
      left: 14px;
      bottom: 14px;
      right: 14px;
      display: flex;
      gap: 10px;
      align-items: flex-end;
      justify-content: space-between;
      pointer-events: none;
    }
    .lightbox-meta .title{
      font-weight: 650;
      font-size: 14px;
      opacity: .95;
      color: rgba(255,255,255,.92);
      text-shadow: 0 8px 22px rgba(0,0,0,.55);
      max-width: 70%;
      line-height: 1.25;
    }
    .lightbox-meta a{
      pointer-events: auto;
      font-size: 12px;
      opacity: .9;
      color: rgba(255,255,255,.92);
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,.35);
    }
    .lightbox-meta a:hover{ opacity: 1; border-bottom-color: rgba(255,255,255,.75); }

    /* Prevent background scroll when lightbox open */
    body.noscroll{ overflow: hidden; }

    /* Lightbox nav buttons */
    .lightbox-nav{
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: blur(6px);
      user-select: none;
    }
    .lightbox-nav:hover{ background: rgba(0,0,0,.55); }

    #lbPrev{ left: 12px; }
    #lbNext{ right: 12px; }

    /* ✅ Multi-image badge on gallery tiles */
    .card{ position: relative; }

    .multi-badge{
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 3;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      line-height: 1;
      backdrop-filter: blur(6px);
      pointer-events: none;
    }

    .multi-badge .stack{
      width: 12px;
      height: 12px;
      display: inline-block;
      border-radius: 3px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.28) inset,
        3px 3px 0 0 rgba(255,255,255,.10);
      opacity: .9;
    }
    .lightbox-vid{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    /* Video thumbnails in gallery tiles */
    .card video{
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      object-fit: cover;
    }
    /* Mobile: keep tiles image-first (hide description text in tiles) */
    @media (max-width: 720px){
      .card .cap .d{ display:none; }
    }
    /* Lightbox description */
    .lightbox-meta{
      align-items: flex-end;
    }
    .lightbox-meta .meta-left{
      display:flex;
      flex-direction:column;
      gap: 6px;
      max-width: 75%;
    }
    .lightbox-meta .desc{
      font-size: 12px;
      line-height: 1.35;
      opacity: .85;
      color: rgba(255,255,255,.88);
      text-shadow: 0 8px 22px rgba(0,0,0,.55);
    }
    /* Mobile: nicer wrapping (max 2 lines, no ugly word breaks) */
    @media (max-width: 720px){
      .lightbox-meta .title{
        max-width: 100%;
        white-space: normal;
        overflow-wrap: normal;   /* break at spaces */
        word-break: keep-all;    /* don't split words */
        hyphens: none;           /* avoid hyphenating names */
        display: -webkit-box;
        -webkit-line-clamp: 2;   /* limit to 2 lines */
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    }
  </style>
</head>
<body>

<!-- =========================
     Header / navigation
========================= -->
<div id="siteHeader"></div>

<main>
<section class="section">
<div class="wrap">

  <div class="section-head gallery-head">
    <div class="gallery-topline">
      <h2>Gallery</h2>
    </div>

    <p class="gallery-intro">
      All images shown here are my own, created through patient hours of long-exposure imaging under dark, often cold night skies, followed by careful processing to reveal faint structures and subtle detail hidden in the data.
    </p>

    <div class="gallery-filter" role="group" aria-label="Gallery filter">
      <label class="gallery-filter-label" for="typeFilter">View gallery images by type</label>

      <div class="gallery-filter-row">
        <select id="typeFilter" class="gallery-filter-select">
          <option value="all">All</option>
          <option value="galaxies">Galaxies</option>
          <option value="nebulae">Nebulae</option>
          <option value="star-clusters">Star Clusters</option>
          <option value="star-trails">Star Trails</option>
          <option value="comets">Comets</option>
          <option value="others">Others</option>
        </select>
        <div class="gallery-filter-spacer"></div>
        <button id="viewToggle" class="view-toggle" type="button" aria-pressed="false">
          List view
        </button>
      </div>
    </div>

    <p class="gallery-hint">
      Click any image to view fullscreen.
    </p>
  </div>

  <div id="galleryGrid" class="grid"></div>

</div>
</section>
</main>

<!-- =========================
     Footer
========================= -->
<div id="siteFooter"></div>

<script>
/* Burger menu controller */
(function(){
  const burger = document.querySelector('.burger');
  const menu = document.querySelector('.nav-menu');
  if(!burger || !menu) return;

  burger.addEventListener('click', () => {
    const open = menu.classList.toggle('open');
    burger.setAttribute('aria-expanded', open ? 'true' : 'false');
  });

  document.addEventListener('click', (e) => {
    if(menu.classList.contains('open') && !menu.contains(e.target) && !burger.contains(e.target)){
      menu.classList.remove('open');
      burger.setAttribute('aria-expanded','false');
    }
  });

  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      menu.classList.remove('open');
      burger.setAttribute('aria-expanded','false');
    }
  });
})();
</script>



<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-label="Image viewer">
  <div class="lightbox-inner">
    <button class="lightbox-close" id="lbClose" aria-label="Close">✕</button>

    <button class="lightbox-nav" id="lbPrev" aria-label="Previous">‹</button>
    <button class="lightbox-nav" id="lbNext" aria-label="Next">›</button>

    <img class="lightbox-img" id="lbImg" alt="" src="" />
    <div class="lightbox-vid" id="lbVid" style="display:none; width:100%; height:100%;"></div>

    <div class="lightbox-watermark" aria-hidden="true"><span>bhapstar</span></div>

    <div class="lightbox-meta" aria-hidden="false">
      <div class="meta-left">
        <div class="title" id="lbTitle"></div>
        <div class="desc" id="lbDesc"></div>
      </div>

      <div class="count" id="lbCount"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const grid = document.getElementById('galleryGrid');

  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lbImg');
  const lbVid = document.getElementById('lbVid');
  const lbTitle = document.getElementById('lbTitle');
  const lbCount = document.getElementById('lbCount');
  const lbDesc = document.getElementById('lbDesc');
  const lbClose = document.getElementById('lbClose');
  const lbPrev = document.getElementById('lbPrev');
  const lbNext = document.getElementById('lbNext');

  const typeFilter = document.getElementById('typeFilter');
  const viewToggle = document.getElementById('viewToggle');

  if(!grid || !lb || !lbImg || !lbTitle || !lbClose) return;

  let items = [];

  async function loadData(){
    try{
      const res = await fetch('gallery-data.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      items = await res.json();
      init(); // continue once items are loaded
    }catch(err){
      console.error('Gallery data load error:', err);
      grid.innerHTML = `<div style="padding:18px;opacity:.8">Could not load gallery-data.json.</div>`;
    }
  }

  // ---- EVERYTHING BELOW is your existing code, moved into init() ----
  function init(){

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function isVideoFile(path){
      return /\.mp4(\?|#|$)/i.test(path || "");
    }

    function getList(item){
      if(item.videos && Array.isArray(item.videos) && item.videos.length){
        return item.videos.map(v => ({
          kind: "vimeo",
          vimeoId: v.vimeoId,
          poster: v.poster,
          alt: v.alt || item.title || ""
        }));
      }
      if(item.images && Array.isArray(item.images) && item.images.length){
        return item.images.map(im => ({
          kind: "image",
          file: im.file,
          alt: im.alt || item.alt || item.title || ""
        }));
      }
      return [{
        kind: "image",
        file: item.file,
        alt: item.alt || item.title || ""
      }];
    }

    function getCover(item){
      const list = getList(item);
      const first = list[0];
      if(first && first.kind === "vimeo"){
        return { file: first.poster, alt: first.alt || item.title || "" };
      }
      return { file: first.file, alt: first.alt || item.title || "" };
    }

    let currentItem = null;
    let lbList = [];
    let lbIndex = 0;

    let activeSet = [];
    let activeItemIndex = 0;

    function showLb(){
      const cur = lbList[lbIndex];

      lbTitle.textContent = currentItem?.title || "";
      if(lbCount){
        lbCount.textContent = lbList.length > 1 ? `${lbIndex + 1} / ${lbList.length}` : "";
      }
      if(lbDesc) lbDesc.textContent = currentItem?.desc || "";

      const canNav = (lbList.length > 1) || (activeSet && activeSet.length > 1);
      if(lbPrev) lbPrev.style.display = canNav ? "" : "none";
      if(lbNext) lbNext.style.display = canNav ? "" : "none";

      lbImg.style.display = "none";
      lbImg.src = "";
      lbImg.alt = "";

      if(lbVid){
        lbVid.style.display = "none";
        lbVid.innerHTML = "";
      }

      if(cur.kind === "vimeo"){
        if(lbVid){
          lbVid.style.display = "block";
          const id = encodeURIComponent(cur.vimeoId);
          lbVid.innerHTML = `
            <iframe
              src="https://player.vimeo.com/video/${id}?autoplay=1&title=0&byline=0&portrait=0"
              frameborder="0"
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
              style="width:100%;height:100%">
            </iframe>
          `;
        }
        return;
      }

      lbImg.style.display = "block";
      lbImg.src = cur.file;
      lbImg.alt = cur.alt || (currentItem?.title || "");
    }

    function goToItem(delta){
      if(!activeSet || activeSet.length < 2) return;

      activeItemIndex = (activeItemIndex + delta + activeSet.length) % activeSet.length;
      currentItem = activeSet[activeItemIndex];
      lbList = getList(currentItem);
      lbIndex = 0;
      showLb();
    }

    function openLightbox(item, indexInActiveSet){
      currentItem = item;
      activeItemIndex = Number(indexInActiveSet) || 0;

      lbList = getList(item);
      lbIndex = 0;
      showLb();

      lb.classList.add('open');
      lb.setAttribute('aria-hidden','false');
      document.body.classList.add('noscroll');
    }

    function closeLightbox(){
      lb.classList.remove('open');
      lb.setAttribute('aria-hidden','true');
      document.body.classList.remove('noscroll');

      if(lbVid){
        lbVid.innerHTML = "";
        lbVid.style.display = "none";
      }

      lbImg.src = "";
      lbImg.alt = "";
      lbImg.style.display = "block";
      lbTitle.textContent = "";
      if(lbDesc) lbDesc.textContent = "";
      if(lbCount) lbCount.textContent = "";

      currentItem = null;
      lbList = [];
      lbIndex = 0;
      activeItemIndex = 0;
    }

    function render(){
      const selected = (typeFilter && typeFilter.value) ? typeFilter.value : 'all';
      const filtered = (selected === 'all')
        ? items
        : items.filter(it => (it.type || 'others') === selected);

      activeSet = filtered;

      grid.innerHTML = filtered.map((item) => {
        const idx = items.indexOf(item);
        const activeIdx = filtered.indexOf(item);

        const cover = getCover(item);
        const list = getList(item);
        const count = list.length;

        const badge = count > 1
          ? `<span class="multi-badge" aria-hidden="true"><span class="stack"></span>${count}</span>`
          : '';

        const media = isVideoFile(cover.file)
          ? `<video src="${esc(cover.file)}" muted playsinline preload="metadata"></video>`
          : `<img src="${esc(cover.file)}" alt="${esc(cover.alt)}" loading="lazy">`;

        return `
          <a class="card"
             href="${esc(cover.file)}"
             data-idx="${idx}"
             data-active-idx="${activeIdx}"
             aria-label="${esc(item.title || cover.alt)}">
            ${badge}
            ${media}
            <div class="cap">
              <div class="t">${esc(item.title || "")}</div>
              <div class="d">${esc(item.desc || "")}</div>
            </div>
          </a>
        `;
      }).join('');
    }

    // (your existing viewToggle / filter / click / key handlers stay the same)
    const isMobile = window.matchMedia('(max-width: 720px)').matches;

    if(isMobile){
      grid.classList.remove('list-view');
      localStorage.setItem('galleryView', 'grid');
      if(viewToggle){
        viewToggle.textContent = 'List view';
        viewToggle.setAttribute('aria-pressed','false');
      }
    } else {
      const savedView = localStorage.getItem('galleryView');
      if(savedView === 'list'){
        grid.classList.add('list-view');
        if(viewToggle){
          viewToggle.textContent = 'Grid view';
          viewToggle.setAttribute('aria-pressed','true');
        }
      } else {
        grid.classList.remove('list-view');
        if(viewToggle){
          viewToggle.textContent = 'List view';
          viewToggle.setAttribute('aria-pressed','false');
        }
      }
    }

    render();

    if(typeFilter) typeFilter.addEventListener('change', render);

    if(viewToggle){
      viewToggle.addEventListener('click', () => {
        if(window.matchMedia('(max-width: 720px)').matches) return;

        const isList = grid.classList.toggle('list-view');
        viewToggle.textContent = isList ? 'Grid view' : 'List view';
        viewToggle.setAttribute('aria-pressed', isList ? 'true' : 'false');
        localStorage.setItem('galleryView', isList ? 'list' : 'grid');
      });
    }

    grid.addEventListener('click', (e) => {
      const a = e.target.closest('a.card');
      if(!a) return;
      e.preventDefault();

      const idx = Number(a.getAttribute('data-idx'));
      const activeIdx = Number(a.getAttribute('data-active-idx'));
      const item = items[idx];
      if(item) openLightbox(item, activeIdx);
    });

    if(lbClose) lbClose.addEventListener('click', closeLightbox);

    if(lbPrev){
      lbPrev.addEventListener('click', (e) => {
        e.stopPropagation();
        if(lbList.length > 1){
          if(lbIndex > 0){ lbIndex -= 1; showLb(); }
          else { goToItem(-1); }
        } else { goToItem(-1); }
      });
    }

    if(lbNext){
      lbNext.addEventListener('click', (e) => {
        e.stopPropagation();
        if(lbList.length > 1){
          if(lbIndex < lbList.length - 1){ lbIndex += 1; showLb(); }
          else { goToItem(+1); }
        } else { goToItem(+1); }
      });
    }

    lb.addEventListener('click', (e) => { if(e.target === lb) closeLightbox(); });

    document.addEventListener('keydown', (e) => {
      if(!lb.classList.contains('open')) return;
      if(e.key === 'Escape') closeLightbox();
      if(e.key === 'ArrowLeft'){
        if(lbList.length > 1){
          if(lbIndex > 0){ lbIndex -= 1; showLb(); } else { goToItem(-1); }
        } else { goToItem(-1); }
      }
      if(e.key === 'ArrowRight'){
        if(lbList.length > 1){
          if(lbIndex < lbList.length - 1){ lbIndex += 1; showLb(); } else { goToItem(+1); }
        } else { goToItem(+1); }
      }
    });

  } // end init()

  loadData();
})();
</script>


<script>
/* Scroll reveal */
(function(){
  const els = Array.from(document.querySelectorAll('.section, .panel, .card'))
    .filter(el => !el.classList.contains('reveal'));

  els.forEach(el => el.classList.add('reveal'));

  if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    els.forEach(el => el.classList.add('in'));
    return;
  }

  const io = new IntersectionObserver((entries) => {
    entries.forEach(en => {
      if(en.isIntersecting){
        en.target.classList.add('in');
        io.unobserve(en.target);
      }
    });
  }, { threshold: 0.12, rootMargin: '0px 0px -8% 0px' });

  els.forEach(el => io.observe(el));
})();
</script>

<script src="protect-images.js"></script>
<script src="partials/partials.js"></script>

</body>
</html>
