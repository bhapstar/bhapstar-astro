<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gear — bhapstar</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "b3353c7dd8764a64baee57fd09c3dbb9"}'></script>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /*
     * FIX 1: The image-protection rule in styles.css sets pointer-events:none on
     * .lightbox-img via the broad selector. We must restore pointer-events on the
     * lightbox image so it doesn't silently swallow taps meant for the buttons.
     */
    .lightbox-img {
      pointer-events: none !important;
    }

    /*
     * FIX 2: Ensure lightbox control buttons have a large-enough touch target
     * and sit in a proper stacking context above the image layer.
     */
    .lightbox-close,
    .lightbox-nav {
      z-index: 10 !important;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(167,139,250,0.25);
      cursor: pointer;
    }

    @media (max-width: 720px) {
      .lightbox-close { width: 48px !important; height: 48px !important; }
      .lightbox-nav   { width: 52px !important; height: 52px !important; font-size: 34px !important; }
      /* On mobile: hide card descriptions — shown in lightbox only */
      .grid .card .cap .d { display: none; }
    }
  </style>
</head>
<body class="page-gear">

<div id="siteHeader"></div>

<main>
  <section class="section">
    <div class="wrap">

      <div class="section-head gallery-head">
        <div class="gallery-topline">
          <h2>Gear</h2>
        </div>

        <p class="gallery-intro">
          Every image in the gallery begins here — with this equipment, set up under the
          night sky. These are the tools of the process: the optics that gather ancient light,
          the mount that holds everything steady against the turning of the Earth, the camera
          that records what the eye cannot see, and the small, unglamorous things that make
          it all work.
        </p>

        <div class="gallery-filter" role="group" aria-label="Gear filters">
          <label class="gallery-filter-label" for="typeFilter">Filter by type</label>
          <div class="gallery-filter-row">
            <select id="typeFilter" class="gallery-filter-select" aria-label="Filter gear by category">
              <option value="all">All</option>
              <option value="telescope">Telescope</option>
              <option value="smart-telescope">Smart Telescope</option>
              <option value="mount">Mount</option>
              <option value="camera">Camera</option>
              <option value="filters">Filters</option>
              <option value="accessories">Accessories</option>
            </select>
          </div>
        </div>

        <p class="gallery-hint">Click any image to view fullscreen · Arrow keys or swipe to navigate</p>
      </div>

      <!-- Skeleton placeholders shown while JSON loads -->
      <div id="gearGrid" class="grid" aria-live="polite" aria-label="Gear gallery">
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
      </div>

    </div>
  </section>
</main>

<div id="siteFooter"></div>


<!-- ─────────────────────────────────────────
     LIGHTBOX
───────────────────────────────────────── -->
<div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="lightbox-inner">

    <button class="lightbox-close" id="lbClose" aria-label="Close image viewer">✕</button>
    <button class="lightbox-nav prev" id="lbPrev" aria-label="Previous image">‹</button>
    <button class="lightbox-nav next" id="lbNext" aria-label="Next image">›</button>

    <img class="lightbox-img" id="lbImg" alt="" src="" />

    <div class="lightbox-watermark" aria-hidden="true"><span>bhapstar</span></div>

    <div class="lightbox-meta">
      <div class="meta-left">
        <div class="title" id="lbTitle"></div>
        <div class="desc"  id="lbDesc"></div>
      </div>
      <div class="count" id="lbCount"></div>
    </div>

    <div class="lightbox-thumbs" id="lbThumbs" aria-label="Thumbnails"></div>

  </div>
</div>


<!-- ─────────────────────────────────────────
     GEAR GALLERY CONTROLLER
     Based directly on gallery.html's proven
     controller — same scroll/touch model.
───────────────────────────────────────── -->
<script>
(function () {
  const grid       = document.getElementById('gearGrid');
  const lb         = document.getElementById('lightbox');
  const lbImg      = document.getElementById('lbImg');
  const lbTitle    = document.getElementById('lbTitle');
  const lbCount    = document.getElementById('lbCount');
  const lbDesc     = document.getElementById('lbDesc');
  const lbClose    = document.getElementById('lbClose');
  const lbPrev     = document.getElementById('lbPrev');
  const lbNext     = document.getElementById('lbNext');
  const lbThumbs   = document.getElementById('lbThumbs');
  const typeFilter = document.getElementById('typeFilter');

  if (!grid || !lb) return;

  let items           = [];
  let currentItem     = null;
  let lbList          = [];   // flat list of images for current item
  let lbIndex         = 0;   // position within lbList
  let activeSet       = [];   // current filtered item array
  let activeItemIndex = 0;   // position within activeSet

  /* ── Load gear data ── */
  async function loadData() {
    try {
      const res = await fetch('gear-data.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      items = await res.json();
      init();
    } catch (err) {
      console.error('Gear data load error:', err);
      grid.innerHTML = `<div class="panel gallery-error grid-span-all">
        <h3>Gallery unavailable</h3>
        <p>Could not load gear-data.json. Please refresh the page.</p>
      </div>`;
    }
  }

  /* ── HTML escape ── */
  function esc(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;').replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;').replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  /* ── Normalise item into a flat list of slide objects ──
     Each slide: { file, alt, desc }
     desc is per-image if set, otherwise null (falls back to item.desc in showLb) */
  function getList(item) {
    if (Array.isArray(item.images) && item.images.length) {
      return item.images.map(x => ({
        file: x.file,
        alt:  x.alt  || item.alt || item.title || '',
        desc: x.desc || null
      }));
    }
    if (Array.isArray(item.files) && item.files.length) {
      return item.files.map(f => ({ file: f, alt: item.alt || item.title || '', desc: null }));
    }
    return [{ file: item.file, alt: item.alt || item.title || '', desc: null }];
  }

  function getCover(item) {
    return getList(item)[0] || { file: '', alt: '' };
  }

  /* ── Lightbox display ── */
  function showLb() {
    const cur = lbList[lbIndex];

    lbTitle.textContent = currentItem?.title || '';
    // Use per-image desc if available, else fall back to item-level desc
    lbDesc.textContent  = cur.desc || currentItem?.desc || '';
    lbCount.textContent = lbList.length > 1 ? `${lbIndex + 1} / ${lbList.length}` : '';

    const canNav = lbList.length > 1 || activeSet.length > 1;
    lbPrev.style.display = canNav ? '' : 'none';
    lbNext.style.display = canNav ? '' : 'none';

    lbImg.src = cur.file;
    lbImg.alt = cur.alt || currentItem?.title || '';

    renderThumbs();
  }

  /* ── Navigate between items (cross-category) ── */
  function goToItem(delta) {
    if (!activeSet || activeSet.length < 2) return;
    activeItemIndex = (activeItemIndex + delta + activeSet.length) % activeSet.length;
    currentItem = activeSet[activeItemIndex];
    lbList  = getList(currentItem);
    lbIndex = delta > 0 ? 0 : lbList.length - 1;
    showLb();
  }

  /* ── Open lightbox ── */
  function openLightbox(item, indexInActiveSet) {
    currentItem     = item;
    activeItemIndex = Number(indexInActiveSet) || 0;
    lbList  = getList(item);
    lbIndex = 0;
    showLb();

    lb.classList.add('open');
    lb.setAttribute('aria-hidden', 'false');
    document.body.classList.add('noscroll');
    requestAnimationFrame(() => lbClose.focus());
  }

  /* ── Close lightbox ── */
  function closeLightbox() {
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('noscroll');

    lbImg.src = '';
    lbTitle.textContent = ''; lbDesc.textContent = ''; lbCount.textContent = '';
    if (lbThumbs) { lbThumbs.innerHTML = ''; lbThumbs.classList.remove('show'); }
    currentItem = null; lbList = []; lbIndex = 0; activeItemIndex = 0;
  }

  /* ── Thumbnail strip (for multi-image items) ── */
  function renderThumbs() {
    if (!lbThumbs) return;

    if (lbList.length <= 1) {
      lbThumbs.innerHTML = '';
      lbThumbs.classList.remove('show');
      return;
    }

    lbThumbs.classList.add('show');
    lbThumbs.innerHTML = lbList.map((x, i) => `
      <button type="button" class="lb-thumb${i === lbIndex ? ' active' : ''}"
              data-i="${i}"
              aria-label="View image ${i + 1}"
              aria-current="${i === lbIndex ? 'true' : 'false'}">
        <img src="${esc(x.file)}" alt="${esc(x.alt)}" loading="lazy" />
      </button>
    `).join('');

    lbThumbs.onclick = (e) => {
      const btn = e.target.closest('button.lb-thumb');
      if (!btn) return;
      lbIndex = Number(btn.dataset.i);
      showLb();
    };
  }

  /* ── Unified tap handler — same pattern as gallery.html ── */
  function addTapHandler(el, fn) {
    el.addEventListener('click', fn);
    el.addEventListener('touchend', function (e) {
      e.preventDefault();
      e.stopPropagation();
      fn(e);
    }, { passive: false });
  }

  /* ── Grid render ── */
  function render() {
    const selected = typeFilter?.value || 'all';
    const filtered = selected === 'all'
      ? items
      : items.filter(it => (it.type || 'accessories') === selected);

    activeSet = filtered;

    grid.innerHTML = filtered.map((item) => {
      const idx       = items.indexOf(item);
      const activeIdx = filtered.indexOf(item);
      const cover     = getCover(item);
      const list      = getList(item);
      const count     = list.length;

      const badge = count > 1
        ? `<span class="multi-badge" aria-hidden="true"><span class="stack"></span>${count}</span>`
        : '';

      return `<a class="card"
           href="${esc(cover.file)}"
           data-idx="${idx}"
           data-active-idx="${activeIdx}"
           aria-label="${esc(item.title || cover.alt)}">
        ${badge}
        <img src="${esc(cover.file)}" alt="${esc(cover.alt)}" loading="lazy" decoding="async">
        <div class="cap">
          <div class="t">${esc(item.title || '')}</div>
          <div class="d">${esc(item.desc  || '')}</div>
        </div>
      </a>`;
    }).join('');
  }

  /* ── Init — all listeners attached once, exactly as gallery.html does it ── */
  function init() {
    render();

    typeFilter?.addEventListener('change', () => {
      closeLightbox();
      render();
    });

    /* Card click → open lightbox */
    grid.addEventListener('click', (e) => {
      const a = e.target.closest('a.card');
      if (!a) return;
      e.preventDefault();
      const item = items[Number(a.dataset.idx)];
      if (item) openLightbox(item, Number(a.dataset.activeIdx));
    });

    addTapHandler(lbClose, closeLightbox);

    addTapHandler(lbPrev, (e) => {
      if (e.stopPropagation) e.stopPropagation();
      if (lbList.length > 1) {
        lbIndex > 0 ? (lbIndex--, showLb()) : goToItem(-1);
      } else {
        goToItem(-1);
      }
    });

    addTapHandler(lbNext, (e) => {
      if (e.stopPropagation) e.stopPropagation();
      if (lbList.length > 1) {
        lbIndex < lbList.length - 1 ? (lbIndex++, showLb()) : goToItem(+1);
      } else {
        goToItem(+1);
      }
    });

    /* Click outside inner panel closes lightbox */
    lb.addEventListener('click', (e) => { if (e.target === lb) closeLightbox(); });

    lb.addEventListener('touchend', (e) => {
      if (e.target === lb) {
        e.preventDefault();
        closeLightbox();
      }
    }, { passive: false });

    /* Keyboard navigation */
    document.addEventListener('keydown', (e) => {
      if (!lb.classList.contains('open')) return;
      if (e.key === 'Escape')     closeLightbox();
      if (e.key === 'ArrowLeft') {
        lbList.length > 1
          ? (lbIndex > 0 ? (lbIndex--, showLb()) : goToItem(-1))
          : goToItem(-1);
      }
      if (e.key === 'ArrowRight') {
        lbList.length > 1
          ? (lbIndex < lbList.length - 1 ? (lbIndex++, showLb()) : goToItem(+1))
          : goToItem(+1);
      }
    });

    /* Touch swipe — passive:true on touchstart so page scroll is never blocked */
    let touchStartX  = 0;
    let touchStartY  = 0;
    let isTouchOnBtn = false;
    const lbInner = lb.querySelector('.lightbox-inner');

    lbInner.addEventListener('touchstart', (e) => {
      isTouchOnBtn = !!e.target.closest('.lightbox-close, .lightbox-nav');
      touchStartX  = e.touches[0].clientX;
      touchStartY  = e.touches[0].clientY;
    }, { passive: true });

    lbInner.addEventListener('touchend', (e) => {
      if (isTouchOnBtn) { isTouchOnBtn = false; return; }
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
        if (dx < 0) {
          lbList.length > 1
            ? (lbIndex < lbList.length - 1 ? (lbIndex++, showLb()) : goToItem(+1))
            : goToItem(+1);
        } else {
          lbList.length > 1
            ? (lbIndex > 0 ? (lbIndex--, showLb()) : goToItem(-1))
            : goToItem(-1);
        }
      }
    }, { passive: true });

  } // end init()

  loadData();
})();
</script>

<script src="protect-images.js"></script>
<script src="partials/partials.js"></script>

</body>
</html>
