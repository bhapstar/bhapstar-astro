<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gear — Bhapstar Astrophotography</title>

  <!-- Cloudflare Web Analytics -->
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js"
    data-cf-beacon='{"token":"b3353c7dd8764a64baee57fd09c3dbb9"}'></script>

  <link rel="stylesheet" href="styles.css" />

  <style>
    .lightbox-img {
      pointer-events: none !important;
    }

    .lightbox-close,
    .lightbox-nav {
      z-index: 10 !important;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(167,139,250,0.25);
      cursor: pointer;
    }

    @media (max-width: 720px) {
      .lightbox-close { width: 48px !important; height: 48px !important; }
      .lightbox-nav   { width: 52px !important; height: 52px !important; font-size: 34px !important; }
      .grid .card .cap .d { display: none; }
    }
  </style>
</head>
<body class="page-gear">

<!-- ── Header (injected by partials.js) ── -->
<div id="siteHeader"></div>

<main>
  <section class="section">
    <div class="wrap">

      <div class="section-head gallery-head">
        <div class="gallery-topline">
          <h2>Gear</h2>
        </div>

        <p class="gallery-intro">
          Every image in the gallery begins here — with this equipment, set up under the
          night sky. These are the tools of the process: the optics that gather ancient light,
          the mount that holds everything steady against the turning of the Earth, the camera
          that records what the eye cannot see, and the small, unglamorous things that make
          it all work.
        </p>

        <div class="gallery-filter" role="group" aria-label="Gear filters">
          <label class="gallery-filter-label" for="typeFilter">Filter by type</label>
          <div class="gallery-filter-row">
            <select id="typeFilter" class="gallery-filter-select" aria-label="Filter gear by category">
              <option value="all">All</option>
              <option value="telescope">Telescope</option>
              <option value="smart-telescope">Smart Telescope</option>
              <option value="mount">Mount</option>
              <option value="camera">Camera</option>
              <option value="filters">Filters</option>
              <option value="accessories">Accessories</option>
            </select>
          </div>
        </div>

        <p class="gallery-hint">Click any image to view fullscreen · Arrow keys or swipe to navigate</p>
      </div>

      <!-- Skeleton placeholders shown while JSON loads -->
      <div id="gearGrid" class="grid" aria-live="polite" aria-label="Gear gallery">
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
      </div>

    </div>
  </section>
</main>

<!-- ── Footer (injected by partials.js) ── -->
<div id="siteFooter"></div>


<!-- ─────────────────────────────────────────
     LIGHTBOX
───────────────────────────────────────── -->
<div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="lightbox-inner">

    <button class="lightbox-close" id="lbClose" aria-label="Close image viewer">✕</button>
    <button class="lightbox-nav prev" id="lbPrev" aria-label="Previous image">‹</button>
    <button class="lightbox-nav next" id="lbNext" aria-label="Next image">›</button>

    <img class="lightbox-img" id="lbImg" alt="" src="" />

    <div class="lightbox-watermark" aria-hidden="true"><span>bhapstar</span></div>

    <div class="lightbox-meta">
      <div class="meta-left">
        <div class="title" id="lbTitle"></div>
        <div class="desc"  id="lbDesc"></div>
      </div>
      <div class="count" id="lbCount"></div>
    </div>

    <!-- Thumbnail strip — only shown for multi-image items -->
    <div class="lightbox-thumbs" id="lbThumbs" aria-label="Thumbnails"></div>

  </div>
</div>


<!-- ─────────────────────────────────────────
     GEAR CONTROLLER
     Identical structure to gallery.html.
     Differences from gallery:
       - Fetches gear-data.json
       - getList() handles images[] with per-slide desc
       - showLb() uses per-slide desc fallback
       - renderThumbs() for multi-image items
       - No video / vimeo support needed
       - No list-view toggle
───────────────────────────────────────── -->
<script>
(function () {
  const grid       = document.getElementById('gearGrid');
  const lb         = document.getElementById('lightbox');
  const lbImg      = document.getElementById('lbImg');
  const lbTitle    = document.getElementById('lbTitle');
  const lbCount    = document.getElementById('lbCount');
  const lbDesc     = document.getElementById('lbDesc');
  const lbClose    = document.getElementById('lbClose');
  const lbPrev     = document.getElementById('lbPrev');
  const lbNext     = document.getElementById('lbNext');
  const lbThumbs   = document.getElementById('lbThumbs');
  const typeFilter = document.getElementById('typeFilter');

  if (!grid || !lb) return;

  let items           = [];
  let currentItem     = null;
  let lbList          = [];
  let lbIndex         = 0;
  let activeSet       = [];
  let activeItemIndex = 0;

  /* ── Load gear data ── */
  async function loadData() {
    try {
      const res = await fetch('gear-data.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      items = await res.json();
      init();
    } catch (err) {
      console.error('Gear data load error:', err);
      grid.innerHTML = `<div class="panel gallery-error grid-span-all">
        <h3>Gallery unavailable</h3>
        <p>Could not load gear-data.json. Please refresh the page.</p>
      </div>`;
    }
  }

  /* ── HTML escape ── */
  function esc(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;').replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;').replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  /* ── Item helpers ──
     getList returns an array of slide objects: { file, alt, desc }
     desc is per-image if defined, otherwise null (showLb falls back to item.desc) */
  function getList(item) {
    if (item.images?.length) {
      return item.images.map(im => ({
        file: im.file,
        alt:  im.alt  || item.alt || item.title || '',
        desc: im.desc || null
      }));
    }
    if (item.files?.length) {
      return item.files.map(f => ({ file: f, alt: item.alt || item.title || '', desc: null }));
    }
    return [{ file: item.file, alt: item.alt || item.title || '', desc: null }];
  }

  function getCover(item) {
    return getList(item)[0] || { file: '', alt: '' };
  }

  /* ── Lightbox display ── */
  function showLb() {
    const cur = lbList[lbIndex];
    lbTitle.textContent = currentItem?.title || '';
    lbDesc.textContent  = cur.desc || currentItem?.desc || '';
    lbCount.textContent = lbList.length > 1 ? `${lbIndex + 1} / ${lbList.length}` : '';

    const canNav = lbList.length > 1 || activeSet.length > 1;
    lbPrev.style.display = canNav ? '' : 'none';
    lbNext.style.display = canNav ? '' : 'none';

    lbImg.style.display = 'block';
    lbImg.src = cur.file;
    lbImg.alt = cur.alt || currentItem?.title || '';

    renderThumbs();
  }

  /* ── Thumbnail strip ── */
  function renderThumbs() {
    if (!lbThumbs) return;
    if (lbList.length <= 1) {
      lbThumbs.innerHTML = '';
      lbThumbs.classList.remove('show');
      return;
    }
    lbThumbs.classList.add('show');
    lbThumbs.innerHTML = lbList.map((x, i) => `
      <button type="button" class="lb-thumb${i === lbIndex ? ' active' : ''}"
              data-i="${i}" aria-label="View image ${i + 1}"
              aria-current="${i === lbIndex ? 'true' : 'false'}">
        <img src="${esc(x.file)}" alt="${esc(x.alt)}" loading="lazy" />
      </button>
    `).join('');
    lbThumbs.onclick = (e) => {
      const btn = e.target.closest('button.lb-thumb');
      if (!btn) return;
      lbIndex = Number(btn.dataset.i);
      showLb();
    };
  }

  /* ── Navigate between items ── */
  function goToItem(delta) {
    if (!activeSet || activeSet.length < 2) return;
    activeItemIndex = (activeItemIndex + delta + activeSet.length) % activeSet.length;
    currentItem = activeSet[activeItemIndex];
    lbList  = getList(currentItem);
    lbIndex = delta > 0 ? 0 : lbList.length - 1;
    showLb();
  }

  /* ── Open / close lightbox ── */
  function openLightbox(item, indexInActiveSet) {
    currentItem     = item;
    activeItemIndex = Number(indexInActiveSet) || 0;
    lbList  = getList(item);
    lbIndex = 0;
    showLb();

    lb.classList.add('open');
    lb.setAttribute('aria-hidden', 'false');
    document.body.classList.add('noscroll');
    requestAnimationFrame(() => lbClose.focus());
  }

  function closeLightbox() {
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('noscroll');

    lbImg.src = ''; lbImg.style.display = 'block';
    lbTitle.textContent = ''; lbDesc.textContent = ''; lbCount.textContent = '';
    if (lbThumbs) { lbThumbs.innerHTML = ''; lbThumbs.classList.remove('show'); }
    currentItem = null; lbList = []; lbIndex = 0; activeItemIndex = 0;
  }

  /* ── Unified tap handler — identical to gallery.html ── */
  function addTapHandler(el, fn) {
    el.addEventListener('click', fn);
    el.addEventListener('touchend', function (e) {
      e.preventDefault();
      e.stopPropagation();
      fn(e);
    }, { passive: false });
  }

  /* ── Grid render ── */
  function render() {
    const selected = typeFilter?.value || 'all';
    const filtered = selected === 'all'
      ? items
      : items.filter(it => (it.type || 'accessories') === selected);

    activeSet = filtered;

    grid.innerHTML = filtered.map((item) => {
      const idx       = items.indexOf(item);
      const activeIdx = filtered.indexOf(item);
      const cover     = getCover(item);
      const list      = getList(item);
      const count     = list.length;

      const badge = count > 1
        ? `<span class="multi-badge" aria-hidden="true"><span class="stack"></span>${count}</span>`
        : '';

      const media = `<img src="${esc(cover.file)}" alt="${esc(cover.alt)}" loading="lazy" decoding="async">`;

      return `<a class="card"
           href="${esc(cover.file)}"
           data-idx="${idx}"
           data-active-idx="${activeIdx}"
           aria-label="${esc(item.title || cover.alt)}">
        ${badge}${media}
        <div class="cap">
          <div class="t">${esc(item.title || '')}</div>
          <div class="d">${esc(item.desc || '')}</div>
        </div>
      </a>`;
    }).join('');
  }

  function init() {
    render();

    typeFilter?.addEventListener('change', render);

    /* Card click → open lightbox — identical to gallery.html */
    grid.addEventListener('click', (e) => {
      const a = e.target.closest('a.card');
      if (!a) return;
      e.preventDefault();
      const item = items[Number(a.dataset.idx)];
      if (item) openLightbox(item, Number(a.dataset.activeIdx));
    });

    addTapHandler(lbClose, closeLightbox);

    addTapHandler(lbPrev, (e) => {
      if (e.stopPropagation) e.stopPropagation();
      if (lbList.length > 1) {
        lbIndex > 0 ? (lbIndex--, showLb()) : goToItem(-1);
      } else {
        goToItem(-1);
      }
    });

    addTapHandler(lbNext, (e) => {
      if (e.stopPropagation) e.stopPropagation();
      if (lbList.length > 1) {
        lbIndex < lbList.length - 1 ? (lbIndex++, showLb()) : goToItem(+1);
      } else {
        goToItem(+1);
      }
    });

    /* Click outside inner panel closes lightbox */
    lb.addEventListener('click', (e) => { if (e.target === lb) closeLightbox(); });

    lb.addEventListener('touchend', (e) => {
      if (e.target === lb) {
        e.preventDefault();
        closeLightbox();
      }
    }, { passive: false });

    /* Keyboard navigation */
    document.addEventListener('keydown', (e) => {
      if (!lb.classList.contains('open')) return;
      if (e.key === 'Escape')     closeLightbox();
      if (e.key === 'ArrowLeft') {
        lbList.length > 1
          ? (lbIndex > 0 ? (lbIndex--, showLb()) : goToItem(-1))
          : goToItem(-1);
      }
      if (e.key === 'ArrowRight') {
        lbList.length > 1
          ? (lbIndex < lbList.length - 1 ? (lbIndex++, showLb()) : goToItem(+1))
          : goToItem(+1);
      }
    });

    /* Touch swipe — identical to gallery.html */
    let touchStartX  = 0;
    let touchStartY  = 0;
    let isTouchOnBtn = false;
    const lbInner = lb.querySelector('.lightbox-inner');

    lbInner.addEventListener('touchstart', (e) => {
      isTouchOnBtn = !!e.target.closest('.lightbox-close, .lightbox-nav');
      touchStartX  = e.touches[0].clientX;
      touchStartY  = e.touches[0].clientY;
    }, { passive: true });

    lbInner.addEventListener('touchend', (e) => {
      if (isTouchOnBtn) { isTouchOnBtn = false; return; }
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
        if (dx < 0) {
          lbList.length > 1
            ? (lbIndex < lbList.length - 1 ? (lbIndex++, showLb()) : goToItem(+1))
            : goToItem(+1);
        } else {
          lbList.length > 1
            ? (lbIndex > 0 ? (lbIndex--, showLb()) : goToItem(-1))
            : goToItem(-1);
        }
      }
    }, { passive: true });

  } // end init()

  loadData();
})();
</script>

<script src="protect-images.js"></script>
<script src="partials/partials.js"></script>

</body>
</html>
