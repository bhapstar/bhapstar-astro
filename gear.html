<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gear — bhapstar</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "b3353c7dd8764a64baee57fd09c3dbb9"}'></script>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* ── Lightbox image: no pointer events (buttons sit above) ── */
    .lightbox-img { pointer-events: none !important; }

    /* ── Lightbox controls: raised z-index + large touch targets ── */
    .lightbox-close,
    .lightbox-nav {
      z-index: 10 !important;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(167,139,250,0.25);
      cursor: pointer;
    }

    @media (max-width: 720px) {
      .lightbox-close { width: 48px !important; height: 48px !important; }
      .lightbox-nav   { width: 52px !important; height: 52px !important; font-size: 34px !important; }

      /* On mobile: hide the card caption so only the image header shows,
         description is revealed in the lightbox — matching gallery behaviour */
      .grid .card .cap .d { display: none; }
    }
  </style>
</head>
<body class="page-gear">

<div id="siteHeader"></div>

<main>
  <section class="section">
    <div class="wrap">

      <div class="section-head gallery-head">
        <div class="gallery-topline">
          <h2>Gear</h2>
        </div>

        <p class="gallery-intro">
          Every image in the gallery begins here — with this equipment, set up under the
          night sky. These are the tools of the process: the optics that gather ancient light,
          the mount that holds everything steady against the turning of the Earth, the camera
          that records what the eye cannot see, and the small, unglamorous things that make
          it all work.
        </p>

        <div class="gallery-filter" role="group" aria-label="Gear filters">
          <label class="gallery-filter-label" for="typeFilter">Filter by type</label>
          <div class="gallery-filter-row">
            <select id="typeFilter" class="gallery-filter-select" aria-label="Filter gear by category">
              <option value="all">All</option>
              <option value="telescope">Telescope</option>
              <option value="smart-telescope">Smart Telescope</option>
              <option value="mount">Mount</option>
              <option value="camera">Camera</option>
              <option value="filters">Filters</option>
              <option value="accessories">Accessories</option>
            </select>
          </div>
        </div>

        <p class="gallery-hint">Click any image to view fullscreen · Arrow keys or swipe to navigate</p>
      </div>

      <!-- Skeleton placeholders shown while JSON loads -->
      <div id="gearGrid" class="grid" aria-live="polite" aria-label="Gear gallery">
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
        <div class="card-skeleton" aria-hidden="true"></div>
      </div>

    </div>
  </section>
</main>

<div id="siteFooter"></div>


<!-- ─────────────────────────────────────────
     LIGHTBOX
───────────────────────────────────────── -->
<div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="lightbox-inner">

    <button class="lightbox-close" id="lbClose" aria-label="Close image viewer">✕</button>
    <button class="lightbox-nav prev" id="lbPrev" aria-label="Previous image">‹</button>
    <button class="lightbox-nav next" id="lbNext" aria-label="Next image">›</button>

    <img class="lightbox-img" id="lbImg" alt="" src="" />
    <div class="lightbox-watermark" aria-hidden="true"><span>bhapstar</span></div>

    <div class="lightbox-meta">
      <div class="meta-left">
        <div class="title" id="lbTitle"></div>
        <div class="desc"  id="lbDesc"></div>
      </div>
      <div class="count" id="lbCount"></div>
    </div>

    <div class="lightbox-thumbs" id="lbThumbs" aria-label="Thumbnails"></div>
  </div>
</div>


<!-- ─────────────────────────────────────────
     GEAR GALLERY CONTROLLER
───────────────────────────────────────── -->
<script>
(function () {
  const grid       = document.getElementById('gearGrid');
  const lb         = document.getElementById('lightbox');
  const lbImg      = document.getElementById('lbImg');
  const lbTitle    = document.getElementById('lbTitle');
  const lbDesc     = document.getElementById('lbDesc');
  const lbCount    = document.getElementById('lbCount');
  const lbThumbs   = document.getElementById('lbThumbs');
  const lbClose    = document.getElementById('lbClose');
  const lbPrev     = document.getElementById('lbPrev');
  const lbNext     = document.getElementById('lbNext');
  const typeFilter = document.getElementById('typeFilter');

  if (!grid || !lb) return;

  let items    = [];   // full dataset from JSON
  let flatList = [];   // flat array of every image across the active (filtered) set
  let flatIndex = 0;

  /* ── Load gear data ── */
  async function loadData() {
    try {
      const res = await fetch('gear-data.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      items = await res.json();
      init();
    } catch (err) {
      console.error('Gear data load error:', err);
      grid.innerHTML = `<div class="panel gallery-error grid-span-all">
        <h3>Gallery unavailable</h3>
        <p>Could not load gear-data.json. Please refresh the page.</p>
      </div>`;
    }
  }

  /* ── HTML escape ── */
  function esc(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;').replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;').replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  /* ── Normalise item into array of file objects ── */
  function getFiles(item) {
    if (Array.isArray(item.images) && item.images.length) {
      return item.images.map(x => ({
        file:  x.file,
        thumb: x.thumb || x.file,
        alt:   x.alt  || item.alt || item.title || '',
        desc:  x.desc || null    // per-image desc; falls back to item.desc in showLb
      }));
    }
    if (Array.isArray(item.files) && item.files.length) {
      return item.files.map(f => ({ file: f, thumb: f, alt: item.alt || item.title || '', desc: null }));
    }
    return [{ file: item.file, thumb: item.file, alt: item.alt || item.title || '', desc: null }];
  }

  function getCoverFile(item) {
    return getFiles(item)[0]?.file || '';
  }

  /* ── Build flat image list from a filtered item set ── */
  function buildFlatList(filteredItems) {
    flatList = [];
    filteredItems.forEach((item, itemIndex) => {
      const files = getFiles(item);
      files.forEach((f, localIndex) => {
        flatList.push({
          file:        f.file,
          alt:         f.alt,
          desc:        f.desc || null,
          itemIndex,           // index within filteredItems
          localIndex,
          totalInItem: files.length
        });
      });
    });
  }

  /* ── Lightbox display ── */
  function showLb(filteredItems) {
    const entry = flatList[flatIndex];
    const item  = filteredItems[entry.itemIndex];

    lbImg.src = entry.file;
    lbImg.alt = entry.alt;

    lbTitle.textContent = item.title || '';
    lbDesc.textContent  = entry.desc || item.desc || '';

    lbCount.textContent = entry.totalInItem > 1
      ? `${entry.localIndex + 1} / ${entry.totalInItem}`
      : '';

    renderThumbs(item, entry.itemIndex, entry.localIndex, filteredItems);
  }

  /* ── Thumbnail strip ── */
  function renderThumbs(item, itemIndex, activeLocal, filteredItems) {
    if (!lbThumbs) return;
    const files = getFiles(item);

    if (files.length <= 1) {
      lbThumbs.innerHTML = '';
      lbThumbs.classList.remove('show');
      return;
    }

    lbThumbs.classList.add('show');
    lbThumbs.innerHTML = files.map((x, i) => `
      <button type="button" class="lb-thumb${i === activeLocal ? ' active' : ''}"
              data-item="${itemIndex}" data-local="${i}"
              aria-label="View image ${i + 1}"
              aria-current="${i === activeLocal ? 'true' : 'false'}">
        <img src="${esc(x.thumb)}" alt="${esc(x.alt)}" loading="lazy" />
      </button>
    `).join('');

    lbThumbs.onclick = (e) => {
      const btn = e.target.closest('button.lb-thumb');
      if (!btn) return;
      const targetItem  = Number(btn.dataset.item);
      const targetLocal = Number(btn.dataset.local);
      const fi = flatList.findIndex(e => e.itemIndex === targetItem && e.localIndex === targetLocal);
      if (fi !== -1) { flatIndex = fi; showLb(filteredItems); }
    };
  }

  /* ── Open lightbox ── */
  function openLightbox(startFlatIndex, filteredItems) {
    flatIndex = startFlatIndex;
    showLb(filteredItems);

    lb.classList.add('open');
    lb.setAttribute('aria-hidden', 'false');
    document.body.classList.add('noscroll');
    requestAnimationFrame(() => lbClose.focus());
  }

  /* ── Close lightbox ── */
  function closeLightbox() {
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('noscroll');

    lbImg.src = '';
    lbTitle.textContent = '';
    lbDesc.textContent  = '';
    lbCount.textContent = '';
    if (lbThumbs) { lbThumbs.innerHTML = ''; lbThumbs.classList.remove('show'); }
  }

  /* ── Unified tap handler (desktop click + mobile touchend) ── */
  function addTapHandler(el, fn) {
    el.addEventListener('click', fn);
    el.addEventListener('touchend', function (e) {
      e.preventDefault();
      e.stopPropagation();
      fn(e);
    }, { passive: false });
  }

  /* ── Render grid and wire up all interactions ── */
  function render() {
    const selected = typeFilter?.value || 'all';
    const filtered = selected === 'all'
      ? items
      : items.filter(it => (it.type || 'accessories') === selected);

    buildFlatList(filtered);

    /* Build grid cards */
    let fi = 0;
    grid.innerHTML = filtered.map((item) => {
      const cover     = getCoverFile(item);
      const files     = getFiles(item);
      const count     = files.length;
      const startFlat = fi;
      fi += count;

      const badge = count > 1
        ? `<span class="multi-badge" aria-hidden="true"><span class="stack"></span>${count}</span>`
        : '';

      return `<a class="card"
           href="${esc(cover)}"
           data-flat="${startFlat}"
           aria-label="${esc(item.title || item.alt || '')}">
        ${badge}
        <img src="${esc(cover)}" alt="${esc(item.alt || item.title || '')}" loading="lazy" decoding="async">
        <div class="cap">
          <div class="t">${esc(item.title || '')}</div>
          <div class="d">${esc(item.desc  || '')}</div>
        </div>
      </a>`;
    }).join('');

    /* Card click → open lightbox */
    grid.onclick = (e) => {
      const a = e.target.closest('a.card');
      if (!a) return;
      e.preventDefault();
      openLightbox(Number(a.dataset.flat), filtered);
    };

    /* Wire up nav buttons with current filtered set in closure */
    function navigate(delta) {
      flatIndex = (flatIndex + delta + flatList.length) % flatList.length;
      showLb(filtered);
    }

    addTapHandler(lbClose, closeLightbox);
    addTapHandler(lbPrev,  (e) => { if (e.stopPropagation) e.stopPropagation(); navigate(-1); });
    addTapHandler(lbNext,  (e) => { if (e.stopPropagation) e.stopPropagation(); navigate(+1); });

    lb.onclick    = (e) => { if (e.target === lb) closeLightbox(); };
    lb.addEventListener('touchend', (e) => {
      if (e.target === lb) { e.preventDefault(); closeLightbox(); }
    }, { passive: false });

    document.onkeydown = (e) => {
      if (!lb.classList.contains('open')) return;
      if (e.key === 'Escape')     closeLightbox();
      if (e.key === 'ArrowLeft')  navigate(-1);
      if (e.key === 'ArrowRight') navigate(+1);
    };

    /* Touch swipe */
    let touchStartX = 0, touchStartY = 0, isTouchOnBtn = false;
    const lbInner = lb.querySelector('.lightbox-inner');

    lbInner.ontouchstart = (e) => {
      isTouchOnBtn = !!e.target.closest('.lightbox-close, .lightbox-nav');
      touchStartX  = e.touches[0].clientX;
      touchStartY  = e.touches[0].clientY;
    };

    lbInner.ontouchend = (e) => {
      if (isTouchOnBtn) { isTouchOnBtn = false; return; }
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
        dx < 0 ? navigate(+1) : navigate(-1);
      }
    };
  }

  /* ── Init ── */
  function init() {
    render();
    typeFilter?.addEventListener('change', () => {
      closeLightbox();
      render();
    });
  }

  loadData();
})();
</script>

<script src="protect-images.js"></script>
<script src="partials/partials.js"></script>

</body>
</html>
